<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Docker Management - Web Appliance Dashboard</title>
    <link rel="stylesheet" href="src/styles.css">
    <link rel="stylesheet" href="src/docker-management/docker-styles.css">
    <style>
        /* Inline Log Enhancement Styles */
        .log-filter-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .filter-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #e0e0e0;
            font-size: 0.875rem;
        }
        
        .filter-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .filter-dot.note { background: #4ecdc4; }
        .filter-dot.warning { background: #ff9800; }
        .filter-dot.error { background: #f44336; }
        
        .log-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-left: auto;
        }
        
        .btn-save {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-save:hover {
            background: #45b7aa;
            transform: translateY(-1px);
        }
        
        .auto-refresh-status {
            color: #4ecdc4;
            font-size: 0.75rem;
        }
        
        .log-stats {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.05);
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem;
            color: #a0a0a0;
            display: flex;
            gap: 1rem;
        }
        
        /* Log line coloring */
        .logs-output .error-line { color: #f44336 !important; }
        .logs-output .warning-line { color: #ff9800 !important; }
        .logs-output .note-line { color: #4ecdc4 !important; }
    </style>
</head>
<body class="docker-management">
    <!-- Setup Overlay -->
    <div id="setupOverlay" class="setup-overlay">
        <div class="setup-dialog">
            <div class="setup-icon">üöÄ</div>
            <h2>Willkommen!</h2>
            <p class="setup-message">
                Die Web Appliance Dashboard App richtet sich beim ersten Start automatisch ein. 
                Dies dauert nur einen Moment...
            </p>
            <div class="setup-spinner-container">
                <div class="setup-spinner"></div>
            </div>
            <div id="setupStatus" class="setup-status">
                <p>üîç Suche Projekt-Verzeichnis...</p>
            </div>
            <div class="setup-footer">
                <p>
                    Die App erstellt ein Arbeitsverzeichnis unter<br>
                    <code>~/Library/Application Support/</code>
                </p>
            </div>
        </div>
    </div>

    <div class="docker-container">
        <!-- Modern Docker Header -->
        <div class="docker-header">
            <h1>
                <svg class="docker-icon" viewBox="0 0 24 24">
                    <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
                </svg>
                Docker Management
            </h1>
            <div class="subtitle">Web Appliance Dashboard Container-Verwaltung</div>
        </div>
        
        <div class="docker-content">
            <!-- Container Control -->
            <div class="docker-section">
                <h2>
                    <svg class="docker-icon" width="20" height="20" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Container-Steuerung
                </h2>
                <div class="controls" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button id="startBtn" class="docker-btn btn-success">
                        <svg viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm0-1A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/>
                        </svg>
                        Starten
                    </button>
                    <button id="stopBtn" class="docker-btn btn-danger">
                        <svg viewBox="0 0 16 16">
                            <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                        </svg>
                        Stoppen
                    </button>
                    <button id="restartBtn" class="docker-btn btn-warning">
                        <svg viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Neustarten
                    </button>
                </div>
                
                <!-- Status -->
                <div id="statusIndicator" class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Pr√ºfe Status...</span>
                </div>
            </div>

            <!-- Container List -->
            <div class="docker-section">
                <h2>
                    <svg class="docker-icon" width="20" height="20" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    Container Status
                </h2>
                <div id="containerList" class="container-list">
                    <div class="loading">Container werden geladen...</div>
                </div>
            </div>

            <!-- Logs with Enhanced Features -->
            <div class="container-logs">
                <h2>Container Logs</h2>
                
                <!-- New Filter Controls -->
                <div class="log-filter-controls">
                    <div class="filter-group">
                        <span style="color: #a0a0a0; font-size: 0.875rem;">Filter:</span>
                        <label class="filter-label">
                            <input type="checkbox" id="filterNote" checked>
                            <span class="filter-dot note"></span>
                            <span>Note</span>
                        </label>
                        <label class="filter-label">
                            <input type="checkbox" id="filterWarning" checked>
                            <span class="filter-dot warning"></span>
                            <span>Warning</span>
                        </label>
                        <label class="filter-label">
                            <input type="checkbox" id="filterError" checked>
                            <span class="filter-dot error"></span>
                            <span>Error</span>
                        </label>
                    </div>
                    <div class="log-actions">
                        <button id="saveLogsBtn" class="btn-save">
                            üíæ Log speichern
                        </button>
                        <span class="auto-refresh-status">
                            Auto-Refresh: <span id="refreshCountdown">5</span>s
                        </span>
                    </div>
                </div>
                
                <div class="log-controls">
                    <select id="logService">
                        <option value="">Alle Container</option>
                        <option value="database">Database</option>
                        <option value="backend">Backend</option>
                        <option value="webserver">Webserver</option>
                        <option value="ttyd">Terminal</option>
                    </select>
                    <button id="refreshLogsBtn" class="docker-btn">
                        <svg viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Logs aktualisieren
                    </button>
                </div>
                <div id="logsOutput" class="logs-output">
                    <div class="loading">Logs werden geladen...</div>
                </div>
                <div class="log-stats">
                    <span>Max. 500 Zeilen</span>
                    <span id="logLineCount">0 Zeilen geladen</span>
                </div>
            </div>
        </div>
    </div>

    <script src="src/renderer.js"></script>
    <script>
        // Enhanced Log Features
        (function() {
            'use strict';
            
            let autoRefreshCountdown = 5;
            let logLines = [];
            
            // Setup auto-refresh countdown
            setInterval(() => {
                autoRefreshCountdown--;
                const countdownEl = document.getElementById('refreshCountdown');
                if (countdownEl) {
                    countdownEl.textContent = autoRefreshCountdown;
                }
                
                if (autoRefreshCountdown <= 0) {
                    autoRefreshCountdown = 5;
                    // Click refresh button
                    document.getElementById('refreshLogsBtn')?.click();
                }
            }, 1000);
            
            // Override log display to add colors and limit lines
            const originalRefreshLogs = window.refreshLogs;
            if (originalRefreshLogs) {
                window.refreshLogs = async function() {
                    const result = await originalRefreshLogs.apply(this, arguments);
                    processLogOutput();
                    return result;
                };
            }
            
            // Watch for log updates
            const logsOutput = document.getElementById('logsOutput');
            if (logsOutput) {
                const observer = new MutationObserver(() => {
                    processLogOutput();
                });
                
                observer.observe(logsOutput, {
                    childList: true,
                    characterData: true,
                    subtree: true
                });
            }
            
            function processLogOutput() {
                const logsOutput = document.getElementById('logsOutput');
                if (!logsOutput || logsOutput.querySelector('.loading')) return;
                
                const text = logsOutput.textContent || '';
                const lines = text.split('\n').filter(line => line.trim());
                
                // Limit to 500 lines
                logLines = lines.slice(-500);
                
                // Update line count
                document.getElementById('logLineCount').textContent = `${logLines.length} Zeilen geladen`;
                
                // Apply colors and filters
                displayFilteredLogs();
            }
            
            function displayFilteredLogs() {
                const logsOutput = document.getElementById('logsOutput');
                if (!logsOutput) return;
                
                const filters = {
                    note: document.getElementById('filterNote')?.checked ?? true,
                    warning: document.getElementById('filterWarning')?.checked ?? true,
                    error: document.getElementById('filterError')?.checked ?? true
                };
                
                const filteredLines = logLines.filter(line => {
                    const lower = line.toLowerCase();
                    if ((lower.includes('error') || lower.includes('fail')) && !filters.error) return false;
                    if (lower.includes('warn') && !filters.warning) return false;
                    if ((lower.includes('info') || lower.includes('note')) && !filters.note) return false;
                    return true;
                });
                
                // Create colored output
                const coloredHtml = filteredLines.map(line => {
                    const lower = line.toLowerCase();
                    let className = '';
                    
                    if (lower.includes('error') || lower.includes('fail')) {
                        className = 'error-line';
                    } else if (lower.includes('warn')) {
                        className = 'warning-line';
                    } else if (lower.includes('info') || lower.includes('note')) {
                        className = 'note-line';
                    }
                    
                    return `<span class="${className}">${escapeHtml(line)}</span>`;
                }).join('\n');
                
                logsOutput.innerHTML = `<pre style="margin: 0; white-space: pre-wrap;">${coloredHtml}</pre>`;
                
                // Scroll to bottom
                logsOutput.scrollTop = logsOutput.scrollHeight;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Setup filter listeners
            ['filterNote', 'filterWarning', 'filterError'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', displayFilteredLogs);
                }
            });
            
            // Setup save button
            const saveBtn = document.getElementById('saveLogsBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `docker-logs-${timestamp}.txt`;
                    const content = logLines.join('\n') || 'Keine Logs vorhanden';
                    
                    // Create download
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // Visual feedback
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '‚úÖ Gespeichert!';
                    saveBtn.style.background = '#4caf50';
                    
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = '';
                    }, 2000);
                });
            }
        })();
    </script>
</body>
</html>
