<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restore Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Restore Functionality Debug Test</h1>
        
        <div>
            <h3>1. Get Auth Token</h3>
            <input type="text" id="token" placeholder="Enter your auth token" style="width: 100%; padding: 8px; margin: 10px 0;">
            <button onclick="saveToken()">Save Token</button>
        </div>

        <div>
            <h3>2. Get Audit Logs</h3>
            <button onclick="getAuditLogs()">Load Audit Logs</button>
            <div id="auditLogs" class="log"></div>
        </div>

        <div>
            <h3>3. Test Restore</h3>
            <input type="number" id="logId" placeholder="Audit Log ID" style="padding: 8px; margin: 10px 0;">
            <select id="resourceType" style="padding: 8px; margin: 10px 0;">
                <option value="appliances">Appliances</option>
                <option value="categories">Categories</option>
                <option value="users">Users</option>
                <option value="ssh-hosts">SSH Hosts</option>
            </select>
            <select id="action" style="padding: 8px; margin: 10px 0;">
                <option value="restore">Restore (deleted)</option>
                <option value="revert">Revert (updated)</option>
            </select>
            <button onclick="testRestore()">Test Restore</button>
            <div id="restoreResult" class="log"></div>
        </div>

        <div>
            <h3>Console Log</h3>
            <div id="console" class="log"></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('debugAuthToken') || '';
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            console.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function saveToken() {
            authToken = document.getElementById('token').value;
            localStorage.setItem('debugAuthToken', authToken);
            log('Token saved', 'success');
        }

        async function getAuditLogs() {
            if (!authToken) {
                log('Please enter auth token first', 'error');
                return;
            }

            try {
                log('Fetching audit logs...');
                const response = await fetch('http://localhost:3001/api/audit-logs?limit=20', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`Found ${data.length} audit logs`, 'success');
                    
                    const logsDiv = document.getElementById('auditLogs');
                    logsDiv.innerHTML = '<h4>Recent Audit Logs:</h4>';
                    
                    data.forEach(log => {
                        const details = typeof log.details === 'string' ? JSON.parse(log.details) : log.details;
                        const name = details?.name || details?.service_name || details?.appliance_name || '';
                        logsDiv.innerHTML += `
                            <div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd;">
                                ID: ${log.id} | Action: ${log.action} | Resource: ${log.resource_type} | Name: ${name}
                            </div>
                        `;
                    });
                } else {
                    log(`Error: ${data.error || 'Failed to fetch logs'}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        async function testRestore() {
            const logId = document.getElementById('logId').value;
            const resourceType = document.getElementById('resourceType').value;
            const action = document.getElementById('action').value;

            if (!logId) {
                log('Please enter an audit log ID', 'error');
                return;
            }

            // Build endpoint
            let endpoint = '';
            if (resourceType === 'appliances') {
                endpoint = action === 'restore' 
                    ? `/api/audit-restore/restore/appliances/${logId}`
                    : `/api/audit-restore/revert/appliances/${logId}`;
            } else if (resourceType === 'categories') {
                endpoint = action === 'restore'
                    ? `/api/restore/category/${logId}`
                    : `/api/restore/category/${logId}/revert`;
            } else if (resourceType === 'users') {
                endpoint = action === 'restore'
                    ? `/api/restore/user/${logId}`
                    : `/api/restore/user/${logId}/revert`;
            } else if (resourceType === 'ssh-hosts') {
                endpoint = action === 'restore'
                    ? `/api/ssh/hosts/restore/${logId}`
                    : `/api/ssh/hosts/${logId}/revert/${logId}`; // Note: needs resource_id
            }

            log(`Testing endpoint: ${endpoint}`);

            try {
                const response = await fetch(`http://localhost:3001${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                document.getElementById('restoreResult').innerHTML = `
                    <h4>Response (Status: ${response.status}):</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

                if (response.ok) {
                    log('Restore successful!', 'success');
                } else {
                    log(`Restore failed: ${data.error || 'Unknown error'}`, 'error');
                    
                    if (response.status === 403) {
                        log('Access denied - you may need admin rights', 'error');
                    }
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
                document.getElementById('restoreResult').innerHTML = `<div class="error">Network error: ${error.message}</div>`;
            }
        }

        // Initialize
        if (authToken) {
            document.getElementById('token').value = authToken;
            log('Token loaded from localStorage', 'success');
        }
    </script>
</body>
</html>
