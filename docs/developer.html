<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Appliance Dashboard - Entwickler Dokumentation v1.1.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        h1 {
            text-align: center;
            color: #61dafb;
            margin-bottom: 50px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #61dafb;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        h3 {
            color: #68d391;
            margin-top: 30px;
        }
        
        .version-badge {
            display: inline-block;
            background: #68d391;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 20px;
        }
        
        .diagram-section {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .mermaid {
            text-align: center;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .description {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.8;
        }
        
        .note {
            background: #4a4a4a;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #61dafb;
            margin: 20px 0;
        }
        
        .changelog {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        pre {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        code {
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        th {
            background: #2d2d2d;
            color: #61dafb;
            font-weight: bold;
        }
        
        tr:hover {
            background: #333;
        }
        
        ul {
            line-height: 1.8;
        }
        
        a {
            color: #61dafb;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web Appliance Dashboard - Entwickler Dokumentation <span class="version-badge">v1.1.0</span></h1>
        
        <div class="changelog">
            <h3>üÜï Neu in Version 1.1.0</h3>
            <ul>
                <li>‚úÖ Remote Desktop Integration (Apache Guacamole)</li>
                <li>‚úÖ Erweiterte SSH Terminal Features</li>
                <li>‚úÖ Glassmorphism UI Design</li>
                <li>‚úÖ Verbesserte Mobile Navigation</li>
                <li>‚úÖ Token-basierte Authentifizierung f√ºr Remote Desktop</li>
            </ul>
        </div>

        <h2>üìä System Architektur</h2>
        
        <div class="diagram-section">
            <h3>Gesamt-Systemarchitektur</h3>
            <div class="mermaid">
graph TB
    subgraph "Frontend"
        UI[React SPA<br/>Port: 9080]
        PWA[PWA Features]
        UI --> PWA
    end
    
    subgraph "Reverse Proxy"
        NGINX[Nginx<br/>Port: 9080/9443]
    end
    
    subgraph "Backend Services"
        API[Node.js API<br/>Port: 3001]
        TTYD[Web Terminal<br/>Port: 7681]
        GUAC[Guacamole<br/>Port: 8080]
        GUACD[Guacd<br/>Port: 4822]
    end
    
    subgraph "Databases"
        MARIADB[(MariaDB<br/>Port: 3306)]
        POSTGRES[(PostgreSQL<br/>Port: 5432)]
    end
    
    subgraph "External Services"
        SSH[SSH Hosts]
        VNC[VNC Servers]
        RDP[RDP Hosts]
    end
    
    UI -->|HTTP/WS| NGINX
    NGINX -->|Proxy /api| API
    NGINX -->|Proxy /terminal| TTYD
    NGINX -->|Proxy /guacamole| GUAC
    
    API -->|Query| MARIADB
    API -->|SSH| SSH
    API -->|Token Auth| GUAC
    
    GUAC -->|Protocol| GUACD
    GUAC -->|Config| POSTGRES
    GUACD -->|VNC| VNC
    GUACD -->|RDP| RDP
    GUACD -->|SSH| SSH
    
    TTYD -->|SSH| SSH
    
    style UI fill:#61dafb,stroke:#333,stroke-width:2px
    style API fill:#68d391,stroke:#333,stroke-width:2px
    style NGINX fill:#ff6b6b,stroke:#333,stroke-width:2px
    style MARIADB fill:#4ecdc4,stroke:#333,stroke-width:2px
    style GUAC fill:#f7b731,stroke:#333,stroke-width:2px
            </div>
            <div class="description">
                <p>Das System besteht aus mehreren Docker-Containern, die √ºber Docker Compose orchestriert werden. Nginx fungiert als zentraler Reverse Proxy und leitet Anfragen an die entsprechenden Services weiter.</p>
            </div>
        </div>

        <div class="diagram-section">
            <h3>Authentication Flow</h3>
            <div class="mermaid">
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant DB as Database
    participant G as Guacamole
    
    U->>F: Login Request
    F->>A: POST /api/auth/login
    A->>DB: Validate Credentials
    DB-->>A: User Data
    A->>A: Generate JWT Token
    A-->>F: JWT Token + User Info
    F->>F: Store Token
    
    Note over F: Authenticated Requests
    
    F->>A: GET /api/appliances<br/>Auth: Bearer JWT
    A->>A: Validate JWT
    A->>DB: Fetch Appliances
    DB-->>A: Appliance Data
    A-->>F: Appliances JSON
    
    Note over F: Remote Desktop Access
    
    F->>A: POST /api/guacamole/token/:id<br/>Auth: Bearer JWT
    A->>A: Validate JWT
    A->>DB: Get Connection Info
    A->>A: Generate Temp Token
    A->>G: Create Token Session
    G-->>A: Token Confirmed
    A-->>F: Guacamole URL + Token
    F->>G: Open Remote Desktop<br/>with Token
            </div>
            <div class="description">
                <p>Die Authentifizierung erfolgt √ºber JWT-Tokens. F√ºr Remote Desktop Zugriffe werden tempor√§re Tokens mit 5 Minuten G√ºltigkeit generiert.</p>
            </div>
        </div>

        <h2>üóÑÔ∏è Datenbank Schema</h2>
        
        <div class="diagram-section">
            <h3>Entity Relationship Diagram</h3>
            <div class="mermaid">
erDiagram
    USERS ||--o{ APPLIANCES : creates
    USERS ||--o{ SSH_KEYS : owns
    USERS ||--o{ AUDIT_LOGS : performs
    APPLIANCES ||--o{ SERVICE_STATUS : has
    APPLIANCES ||--o{ APPLIANCE_SSH_KEYS : uses
    SSH_KEYS ||--o{ APPLIANCE_SSH_KEYS : assigned_to
    CATEGORIES ||--o{ APPLIANCES : contains
    
    USERS {
        int id PK
        string username UK
        string password_hash
        string email
        string role
        timestamp created_at
        timestamp last_login
    }
    
    APPLIANCES {
        int id PK
        string name
        string url
        string icon
        int category_id FK
        int user_id FK
        string ssh_host
        string ssh_username
        int ssh_port
        boolean ssh_enabled
        boolean remote_desktop_enabled
        string remote_protocol
        string remote_host
        int remote_port
        string remote_username
        string remote_password_encrypted
        timestamp created_at
        timestamp updated_at
    }
    
    SSH_KEYS {
        int id PK
        int user_id FK
        string name
        string type
        text public_key
        text private_key_encrypted
        timestamp created_at
    }
    
    SERVICE_STATUS {
        int id PK
        int appliance_id FK
        string status
        string service_info
        timestamp last_check
        timestamp created_at
    }
    
    AUDIT_LOGS {
        int id PK
        int user_id FK
        string action
        string entity_type
        int entity_id
        text details
        string ip_address
        timestamp created_at
    }
    
    CATEGORIES {
        int id PK
        string name
        string slug
        string color
        int display_order
    }
            </div>
            <div class="description">
                <p>Die Datenbank verwendet MariaDB f√ºr die Hauptanwendung und PostgreSQL f√ºr Guacamole. Passw√∂rter und SSH-Keys werden verschl√ºsselt gespeichert.</p>
            </div>
        </div>

        <h2>üîÑ API Request Flow</h2>
        
        <div class="diagram-section">
            <h3>Service Control Flow</h3>
            <div class="mermaid">
flowchart LR
    A[Frontend] -->|Request| B[Nginx]
    B -->|/api/*| C[API Server]
    C -->|Validate| D{Auth OK?}
    D -->|No| E[401 Error]
    D -->|Yes| F[Process Request]
    F -->|SSH Command| G[SSH Host]
    G -->|Result| F
    F -->|Update| H[(Database)]
    F -->|Response| C
    C -->|JSON| B
    B -->|Response| A
    
    style A fill:#61dafb
    style C fill:#68d391
    style H fill:#4ecdc4
    style E fill:#ff6b6b
            </div>
        </div>

        <h2>üê≥ Docker Architektur</h2>
        
        <div class="diagram-section">
            <h3>Container Struktur</h3>
            <div class="mermaid">
graph TD
    subgraph "Docker Network: appliance_network"
        subgraph "Frontend Services"
            NGINX[nginx<br/>9080:80<br/>9443:443]
            FRONTEND[frontend<br/>Build Only]
        end
        
        subgraph "Backend Services"
            API[backend<br/>3001:3001]
            TTYD[ttyd<br/>7681:7681]
        end
        
        subgraph "Remote Desktop"
            GUAC[guacamole<br/>8080:8080]
            GUACD[guacd<br/>4822:4822]
        end
        
        subgraph "Databases"
            MARIADB[database<br/>3306:3306]
            POSTGRES[guacamole-postgres<br/>5432:5432]
        end
    end
    
    subgraph "Volumes"
        V1[frontend_build]
        V2[mariadb_data]
        V3[postgres_data]
        V4[ssh_keys]
        V5[uploads]
    end
    
    FRONTEND -.->|build| V1
    NGINX -->|serve| V1
    MARIADB -->|persist| V2
    POSTGRES -->|persist| V3
    API -->|store| V4
    API -->|store| V5
    
    style NGINX fill:#ff6b6b
    style API fill:#68d391
    style MARIADB fill:#4ecdc4
    style GUAC fill:#f7b731
            </div>
        </div>

        <h2>üöÄ Build & Deployment Pipeline</h2>
        
        <div class="diagram-section">
            <h3>Build Process</h3>
            <div class="mermaid">
flowchart TD
    A[Start Build] -->|./scripts/build.sh| B{Check Args}
    B -->|--nocache| C[Clean Docker Cache]
    B -->|default| D[Use Cache]
    C --> E[Setup Environment]
    D --> E
    E -->|Copy .env files| F[Build Frontend]
    F -->|npm run build| G[Build Backend Image]
    G -->|Docker build| H{Remote Desktop?}
    H -->|Yes| I[Build Guacamole]
    H -->|No| J[Skip Guacamole]
    I --> K[Build ttyd]
    J --> K
    K --> L[Start Containers]
    L --> M[Run Migrations]
    M --> N[Health Checks]
    N --> O{All OK?}
    O -->|Yes| P[‚úÖ Success]
    O -->|No| Q[‚ùå Show Errors]
    
    style A fill:#61dafb
    style P fill:#68d391
    style Q fill:#ff6b6b
            </div>
        </div>

        <h2>üîí Security Architecture</h2>
        
        <div class="diagram-section">
            <h3>Security Layers</h3>
            <div class="mermaid">
graph TB
    subgraph "External"
        USER[User Request]
    end
    
    subgraph "Layer 1: Nginx"
        RATE[Rate Limiting]
        SSL[SSL/TLS]
        CORS[CORS Headers]
    end
    
    subgraph "Layer 2: API"
        JWT[JWT Validation]
        RBAC[Role Based Access]
        INPUT[Input Validation]
    end
    
    subgraph "Layer 3: Backend"
        CRYPT[Encryption]
        HASH[Password Hashing]
        ESCAPE[SQL Escaping]
    end
    
    subgraph "Layer 4: Infrastructure"
        DOCKER[Docker Isolation]
        SECRETS[Environment Secrets]
        FIREWALL[Firewall Rules]
    end
    
    USER --> RATE
    RATE --> SSL
    SSL --> CORS
    CORS --> JWT
    JWT --> RBAC
    RBAC --> INPUT
    INPUT --> CRYPT
    CRYPT --> HASH
    HASH --> ESCAPE
    ESCAPE --> DOCKER
    DOCKER --> SECRETS
    SECRETS --> FIREWALL
    
    style USER fill:#ff6b6b
    style JWT fill:#61dafb
    style CRYPT fill:#68d391
            </div>
            <div class="description">
                <h4>Sicherheitsma√ünahmen:</h4>
                <ul>
                    <li><strong>Rate Limiting:</strong> Nginx begrenzt Anfragen pro IP</li>
                    <li><strong>JWT Tokens:</strong> Stateless Authentication mit Expiration</li>
                    <li><strong>Verschl√ºsselung:</strong> AES-256 f√ºr Passw√∂rter und SSH-Keys</li>
                    <li><strong>RBAC:</strong> Admin und User Rollen</li>
                    <li><strong>Input Validation:</strong> Sanitization aller Eingaben</li>
                    <li><strong>Docker Isolation:</strong> Container-basierte Trennung</li>
                </ul>
            </div>
        </div>

        <h2>üì° WebSocket Communication</h2>
        
        <div class="diagram-section">
            <h3>Real-time Updates (SSE)</h3>
            <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant N as Nginx
    participant A as API Server
    participant W as Worker
    participant D as Database
    
    C->>N: GET /api/sse
    N->>A: Proxy SSE Request
    A->>A: Create SSE Stream
    A-->>C: HTTP 200<br/>Content-Type: text/event-stream
    
    loop Health Check Interval
        W->>D: Check Service Status
        D-->>W: Current Status
        W->>W: Compare Changes
        alt Status Changed
            W->>A: Emit Update Event
            A-->>C: data: {status update}<br/><br/>
        end
    end
    
    C->>N: Close Connection
    N->>A: Connection Closed
    A->>A: Clean up Stream
            </div>
        </div>

        <h2>üõ†Ô∏è Development Setup</h2>
        
        <div class="description">
            <h3>Prerequisites</h3>
            <pre>
- Docker & Docker Compose v2.0+
- Node.js 18+
- Git
- 4GB RAM (minimum)
- 10GB free disk space
            </pre>
            
            <h3>Quick Start</h3>
            <pre>
# Clone repository
git clone git@github.com:alflewerken/web-appliance-dashboard.git
cd web-appliance-dashboard

# Setup environment
./scripts/setup-env.sh

# Build and start
./scripts/build.sh --nocache

# Access dashboard
open http://localhost:9080
            </pre>
            
            <h3>Development Mode</h3>
            <pre>
# Backend development with hot reload
cd backend && npm run dev

# Frontend development
cd frontend && npm start

# Docker development mode
docker compose -f docker-compose.yml -f docker-compose.dev.yml up
            </pre>
        </div>

        <h2>üìö API Endpoints Overview</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Endpoint</th>
                    <th>Method</th>
                    <th>Description</th>
                    <th>Auth Required</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>/api/auth/login</td>
                    <td>POST</td>
                    <td>User login</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td>/api/appliances</td>
                    <td>GET</td>
                    <td>List all appliances</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/appliances</td>
                    <td>POST</td>
                    <td>Create new appliance</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/appliances/:id</td>
                    <td>PUT</td>
                    <td>Update appliance</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/appliances/:id</td>
                    <td>DELETE</td>
                    <td>Delete appliance</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/ssh/keys</td>
                    <td>GET</td>
                    <td>List SSH keys</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/ssh/test</td>
                    <td>POST</td>
                    <td>Test SSH connection</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/terminal/create</td>
                    <td>POST</td>
                    <td>Create terminal session</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/guacamole/token/:id</td>
                    <td>POST</td>
                    <td>Get remote desktop token</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>/api/backup/create</td>
                    <td>POST</td>
                    <td>Create system backup</td>
                    <td>Yes (Admin)</td>
                </tr>
                <tr>
                    <td>/api/audit-logs</td>
                    <td>GET</td>
                    <td>View audit logs</td>
                    <td>Yes (Admin)</td>
                </tr>
                <tr>
                    <td>/api/sse</td>
                    <td>GET</td>
                    <td>Server-sent events stream</td>
                    <td>Yes</td>
                </tr>
            </tbody>
        </table>

        <h2>üß™ Testing Strategy</h2>
        
        <div class="diagram-section">
            <h3>Test Pyramid</h3>
            <div class="mermaid">
graph BT
    A[Unit Tests<br/>Jest, React Testing Library]
    B[Integration Tests<br/>API Tests, DB Tests]
    C[E2E Tests<br/>Cypress/Playwright]
    D[Manual Tests<br/>User Acceptance]
    
    A -->|Many| B
    B -->|Some| C
    C -->|Few| D
    
    style A fill:#68d391,stroke:#333,stroke-width:2px
    style B fill:#61dafb,stroke:#333,stroke-width:2px
    style C fill:#f7b731,stroke:#333,stroke-width:2px
    style D fill:#ff6b6b,stroke:#333,stroke-width:2px
            </div>
            <div class="description">
                <h4>Test Coverage Goals:</h4>
                <ul>
                    <li>Unit Tests: >80% coverage</li>
                    <li>Integration Tests: All API endpoints</li>
                    <li>E2E Tests: Critical user journeys</li>
                    <li>Performance Tests: Load testing with k6</li>
                </ul>
            </div>
        </div>

        <h2>üö® Monitoring & Logging</h2>
        
        <div class="description">
            <h3>Log Aggregation</h3>
            <pre>
# View all logs
docker compose logs -f

# Specific service logs
docker compose logs -f backend
docker compose logs -f nginx

# Export logs
docker compose logs > logs/system-$(date +%Y%m%d).log
            </pre>
            
            <h3>Health Monitoring</h3>
            <pre>
# Check system status
./status.sh

# Health endpoints
curl http://localhost:9080/api/health
curl http://localhost:9080/api/health/detailed
            </pre>
        </div>

        <h2>üìã Troubleshooting</h2>
        
        <div class="note">
            <h3>Common Issues</h3>
            <ul>
                <li><strong>Port conflicts:</strong> Check if ports 9080, 3001, 3306, 5432 are free</li>
                <li><strong>Docker memory:</strong> Increase Docker Desktop memory to 4GB minimum</li>
                <li><strong>Permission errors:</strong> Run <code>chmod +x scripts/*.sh</code></li>
                <li><strong>Database connection:</strong> Wait 30s after start for DB initialization</li>
                <li><strong>Guacamole on M1:</strong> Requires Rosetta emulation</li>
            </ul>
        </div>

        <h2>üîó Useful Links</h2>
        
        <ul>
            <li><a href="https://github.com/alflewerken/web-appliance-dashboard">GitHub Repository</a></li>
            <li><a href="../api-reference.md">API Documentation</a></li>
            <li><a href="../user-manual/">User Manual</a></li>
            <li><a href="http://localhost:9080/api-docs">Swagger UI</a> (when running)</li>
        </ul>
        
        <div class="note">
            <p><strong>Version:</strong> 1.1.0 | <strong>Last Updated:</strong> July 24, 2025</p>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            theme: 'dark',
            themeVariables: {
                primaryColor: '#61dafb',
                primaryTextColor: '#fff',
                primaryBorderColor: '#7C0000',
                lineColor: '#F8B229',
                secondaryColor: '#006100',
                tertiaryColor: '#fff'
            }
        });
    </script>
</body>
</html>