# Guacamole internal proxy configuration
# This proxies Guacamole through the main nginx with authentication

location /guacamole/ {
    # Only allow authenticated requests from the dashboard
    # Check for a valid session cookie or API token
    
    # First, try to validate through the backend
    auth_request /api/auth/validate-guacamole-access;
    auth_request_set $auth_status $upstream_status;
    
    # If validation fails, deny access
    error_page 401 = @guacamole_denied;
    
    # Proxy to Guacamole (internal only)
    proxy_pass http://guacamole:8080/guacamole/;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_cookie_path /guacamole/ /guacamole/;
    
    # Increase timeouts for RDP/VNC sessions
    proxy_connect_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;
}

location @guacamole_denied {
    return 401 "Unauthorized access to Guacamole";
}

# Special location for WebSocket connections
location /guacamole/websocket-tunnel {
    # Validate access
    auth_request /api/auth/validate-guacamole-access;
    error_page 401 = @guacamole_denied;
    
    proxy_pass http://guacamole:8080/guacamole/websocket-tunnel;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # Disable proxy buffering for WebSocket
    proxy_buffering off;
    
    # Increase timeouts
    proxy_connect_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;
}