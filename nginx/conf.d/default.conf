server {
    listen 80 default_server;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Increase body size limit for large background images and backup files
    client_max_body_size 200M;

    # WICHTIG für Docker Desktop auf Mac/Windows:
    # Verwende die originale Client-IP aus dem ersten Proxy
    # Docker Desktop fügt die echte IP in X-Forwarded-For hinzu
    

    # Frontend routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # WebSocket proxy for terminal connections - HIGHEST PRIORITY
    location ~ ^/api/terminal/(.*)$ {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        
        # WebSocket specific headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        
        # Pass real client IP - WICHTIG: Nutze $real_client_ip
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # WebSocket specific settings
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # Keep connection alive
        proxy_connect_timeout 10s;
    }

    # WebSocket proxy for terminal-session - NEW ROUTE
    location = /api/terminal-session {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        
        # WebSocket specific headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        
        # Pass real client IP
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # WebSocket specific settings
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # Keep connection alive
        proxy_connect_timeout 10s;
    }

    # Server-Sent Events (SSE) proxy - MUST BE BEFORE GENERAL API
    location /api/sse/stream {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        
        # SSE specific headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header Connection '';
        
        # SSE specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        chunked_transfer_encoding on;
        
        # Disable nginx buffering for SSE
        proxy_set_header X-Accel-Buffering no;
        
        # Keep connection alive
        keepalive_timeout 86400s;
    }

    # SSH API proxy with extended timeouts for setup operations
    location /api/ssh/ {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_cache_bypass $http_upgrade;
        
        # Extended timeouts for SSH operations (setup can take time)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Send timeout for client
        send_timeout 300s;
    }

    # ttyd Web Terminal proxy
    location /terminal/ {
        proxy_pass http://ttyd:7681/;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Authentication header pass-through
        proxy_set_header Authorization $http_authorization;
        
        # Disable buffering for real-time terminal
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 60s;
        
        # Frame options for iframe embedding
        add_header X-Frame-Options "SAMEORIGIN";
    }

    # ttyd Web Terminal proxy - v1 compatibility with appliance ID
    location ~ ^/terminal/v1/(\d+)$ {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ttyd Web Terminal proxy - v1 compatibility (static)
    location /terminal/v1 {
        proxy_pass http://ttyd:7681/;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Authentication header pass-through
        proxy_set_header Authorization $http_authorization;
        
        # Disable buffering for real-time terminal
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 60s;
        
        # Frame options for iframe embedding
        add_header X-Frame-Options "SAMEORIGIN";
    }

    # ttyd WebSocket specific route
    location /terminal/ws {
        proxy_pass http://ttyd:7681/ws;
        proxy_http_version 1.1;
        
        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        
        # No buffering for WebSocket
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # API proxy
    location /api/ {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        
        # Pass real client IP - WICHTIG: Nutze $real_client_ip
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        proxy_cache_bypass $http_upgrade;
        
        # Increase body size limit for large backup files specifically for API calls
        client_max_body_size 200M;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Upload files proxy (for background images) - HIGHER PRIORITY
    location ^~ /uploads/ {
        proxy_pass http://backend:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $real_client_ip;
        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # Allow larger uploads for background images (up to 50MB)
        client_max_body_size 50M;
        
        # Cache uploaded images
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Security headers for static files (excluding uploads)
    location ~* ^(?!/uploads/).*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    error_page 404 /index.html;
}
